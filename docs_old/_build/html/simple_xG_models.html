<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Expected Goals (xG) &mdash; databallpy  documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="_static/jquery.js?v=5d32c60e"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="_static/documentation_options.js?v=5929fcd5"></script>
        <script src="_static/doctools.js?v=888ff710"></script>
        <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Changelog" href="changelog.html" />
    <link rel="prev" title="Example usage" href="example.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            databallpy
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Table of Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="example.html">Example usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="example.html#Tracking-Data">Tracking Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="example.html#Event-Data">Event Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="example.html#Metadata">Metadata</a></li>
<li class="toctree-l1"><a class="reference internal" href="example.html#Synchronising-tracking-and-event-data">Synchronising tracking and event data</a></li>
<li class="toctree-l1"><a class="reference internal" href="example.html#Databallpy-events">Databallpy events</a></li>
<li class="toctree-l1"><a class="reference internal" href="example.html#Add-features-to-the-data">Add features to the data</a></li>
<li class="toctree-l1"><a class="reference internal" href="example.html#Save-Match-Clip">Save Match Clip</a></li>
<li class="toctree-l1"><a class="reference internal" href="example.html#Plot-events">Plot events</a></li>
<li class="toctree-l1"><a class="reference internal" href="example.html#Conclusion">Conclusion</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Expected Goals (xG)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#data-preprocessing">Data preprocessing</a></li>
<li class="toctree-l2"><a class="reference internal" href="#data-exploration">Data exploration</a></li>
<li class="toctree-l2"><a class="reference internal" href="#building-the-xg-models">Building the xG models</a></li>
<li class="toctree-l2"><a class="reference internal" href="#inspecting-the-models">Inspecting the models</a></li>
<li class="toctree-l2"><a class="reference internal" href="#saving-the-models">Saving the models</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="conduct.html">Code of Conduct</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">Contributing</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">databallpy</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Expected Goals (xG)</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/simple_xG_models.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="expected-goals-xg">
<h1>Expected Goals (xG)<a class="headerlink" href="#expected-goals-xg" title="Link to this heading"></a></h1>
<p>This is a notebook that creates some simple xG models for the DataBallPy
package. xG is a metric to evaluate the probability that a shot, given
some characteristics of that shot, will turn out to be a goal. xG has
been highly debated and discussed and is used increasingly in practice.
Their is a lot of information about expected goals, but if you want to
read more, I highly recommend the blog posts from the KU Leuven:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://dtai.cs.kuleuven.be/sports/blog/how-data-availability-affects-the-ability-to-learn-good-xg-models">How data availability influences xG
models</a></p></li>
<li><p><a class="reference external" href="https://dtai.cs.kuleuven.be/sports/blog/illustrating-the-interplay-between-features-and-models-in-xg">Illustrating the interplay between features and models in
xG</a></p></li>
<li><p><a class="reference external" href="https://dtai.cs.kuleuven.be/sports/blog/how-data-quality-affects-xg">How data quality affect xG
performance</a></p></li>
<li><p><a class="reference external" href="https://dtai.cs.kuleuven.be/sports/blog/enhancing-xg-models-with-freeze-frame-data">Enhancing xG with freeze frame
data</a></p></li>
</ul>
<p>Although we do have tracking data which provides us with the possibility
to create a rather complex xG model, in this notebook we decided to keep
things rather simple for two reasons: (1) The added performance xG
models that use tracking data is low compared to xG models that do not
use tracking data related features, and (2) keeping the model simple
makes it easier to interpretet the model. Lets get started!</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib.colors</span> <span class="kn">import</span> <span class="n">LinearSegmentedColormap</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>

<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span><span class="p">,</span> <span class="n">FunctionTransformer</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">brier_score_loss</span>
<span class="kn">from</span> <span class="nn">sklearn.pipeline</span> <span class="kn">import</span> <span class="n">Pipeline</span>
<span class="kn">import</span> <span class="nn">joblib</span>

<span class="kn">from</span> <span class="nn">databallpy.features.angle</span> <span class="kn">import</span> <span class="n">get_smallest_angle</span>
<span class="kn">from</span> <span class="nn">databallpy.visualize</span> <span class="kn">import</span> <span class="n">plot_soccer_pitch</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;../data/shot_features.csv&quot;</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="s2">&quot;Unnamed: 0&quot;</span><span class="p">)</span>
<span class="n">data</span><span class="p">[</span><span class="s2">&quot;shot_outcome&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;shot_outcome&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">x</span><span class="o">==</span><span class="s2">&quot;goal&quot;</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<section id="data-preprocessing">
<h2>Data preprocessing<a class="headerlink" href="#data-preprocessing" title="Link to this heading"></a></h2>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># delete all shots from own half, probably an error in the data</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;ball_goal_distance&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">53</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="c1"># create single column that indicates whether the shot was taken by foot or not</span>
<span class="n">data</span><span class="p">[</span><span class="s2">&quot;is_by_foot&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;body_part&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">1</span> <span class="k">if</span> <span class="s2">&quot;foot&quot;</span> <span class="ow">in</span> <span class="n">x</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;body_part&quot;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># For this model, we are really only interested in the shot distance and the shot angle</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[[</span><span class="s2">&quot;ball_goal_distance&quot;</span><span class="p">,</span> <span class="s2">&quot;shot_angle&quot;</span><span class="p">,</span> <span class="s2">&quot;is_by_foot&quot;</span><span class="p">,</span> <span class="s2">&quot;type_of_play&quot;</span><span class="p">,</span> <span class="s2">&quot;shot_outcome&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;shot_outcome&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">info</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">describe</span><span class="p">())</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>shot_outcome
0    14138
1     1706
Name: count, dtype: int64
&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
Index: 15844 entries, 0 to 41
Data columns (total 5 columns):
 #   Column              Non-Null Count  Dtype
---  ------              --------------  -----
 0   ball_goal_distance  15844 non-null  float64
 1   shot_angle          15844 non-null  float64
 2   is_by_foot          15844 non-null  int64
 3   type_of_play        15844 non-null  object
 4   shot_outcome        15844 non-null  int64
dtypes: float64(2), int64(2), object(1)
memory usage: 742.7+ KB
None
       ball_goal_distance    shot_angle    is_by_foot  shot_outcome
count        15844.000000  15844.000000  15844.000000  15844.000000
mean            17.069520     26.114796      0.819111      0.107675
std              7.794867     16.745407      0.384938      0.309979
min              0.600167      0.022857      0.000000      0.000000
25%             10.637804     15.295443      1.000000      0.000000
50%             16.491207     20.207843      1.000000      0.000000
75%             22.738823     32.808210      1.000000      0.000000
max             52.992204    179.654562      1.000000      1.000000
</pre></div>
</div>
<p>Looking at the data, we have a total of 15844 shots, of which 1706 are
actual goals (10.8%). Our baseline model would just assume that every
shot has a 10.8% chance of being a goal, but I think we can do better.
The next step is creating different datasets for different types of
shots. In open play, you either shoot by foot, or with an header
(roughly speaking). Second, we also have set pieces. For penalties, we
know that all features (distance to goal and shot angle) are equal, so
the xG of a penalty is just the success rate of all penalties in our
dataset. For free kicks, the distance and goal angle is variable,
therefore we will also create a model for free kicks specifically. Last,
we will create a xG for all shots, to evaluate if the different types of
shots actually are different in terms of xG or not.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">open_play_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;type_of_play&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s2">&quot;regular_play&quot;</span><span class="p">,</span> <span class="s2">&quot;corner_kick&quot;</span><span class="p">,</span> <span class="s2">&quot;crossed_free_kick&quot;</span><span class="p">,</span> <span class="s2">&quot;counter_attack&quot;</span><span class="p">])]</span>
<span class="n">free_kick_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;type_of_play&quot;</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;free_kick&quot;</span><span class="p">]</span>
<span class="n">penalty_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;type_of_play&quot;</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;penalty&quot;</span><span class="p">]</span>
<span class="n">foot_data</span> <span class="o">=</span> <span class="n">open_play_data</span><span class="p">[</span><span class="n">open_play_data</span><span class="p">[</span><span class="s2">&quot;is_by_foot&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">header_data</span> <span class="o">=</span> <span class="n">open_play_data</span><span class="p">[</span><span class="n">open_play_data</span><span class="p">[</span><span class="s2">&quot;is_by_foot&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>

<span class="n">all_datasets</span> <span class="o">=</span> <span class="p">[</span><span class="n">foot_data</span><span class="p">,</span> <span class="n">header_data</span><span class="p">,</span> <span class="n">free_kick_data</span><span class="p">]</span>
<span class="n">all_shots</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">all_datasets</span><span class="p">)</span>
<span class="n">all_datasets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">all_shots</span><span class="p">)</span>

<span class="n">titles</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;shots by foot&quot;</span><span class="p">,</span> <span class="s2">&quot;shots by header&quot;</span><span class="p">,</span> <span class="s2">&quot;shots by free kick&quot;</span><span class="p">,</span> <span class="s2">&quot;shots from all situations combined&quot;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The xG of a penalty in our dataset is </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">penalty_data</span><span class="p">[</span><span class="n">penalty_data</span><span class="p">[</span><span class="s2">&quot;shot_outcome&quot;</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">])</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">penalty_data</span><span class="p">),</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">data</span><span class="p">,</span> <span class="n">title</span> <span class="ow">in</span> <span class="nb">zip</span> <span class="p">(</span><span class="n">all_datasets</span><span class="p">,</span> <span class="n">titles</span><span class="p">):</span>
    <span class="n">n_goals</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;shot_outcome&quot;</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;We have </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">, of which </span><span class="si">{</span><span class="n">n_goals</span><span class="si">}</span><span class="s2"> is a goal (</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">n_goals</span><span class="o">*</span><span class="mi">100</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">%).&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">The</span> <span class="n">xG</span> <span class="n">of</span> <span class="n">a</span> <span class="n">penalty</span> <span class="ow">in</span> <span class="n">our</span> <span class="n">dataset</span> <span class="ow">is</span> <span class="mf">0.792</span>

<span class="n">We</span> <span class="n">have</span> <span class="mi">12322</span> <span class="n">shots</span> <span class="n">by</span> <span class="n">foot</span><span class="p">,</span> <span class="n">of</span> <span class="n">which</span> <span class="mi">1281</span> <span class="ow">is</span> <span class="n">a</span> <span class="n">goal</span> <span class="p">(</span><span class="mf">10.4</span><span class="o">%</span><span class="p">)</span><span class="o">.</span>
<span class="n">We</span> <span class="n">have</span> <span class="mi">2866</span> <span class="n">shots</span> <span class="n">by</span> <span class="n">header</span><span class="p">,</span> <span class="n">of</span> <span class="n">which</span> <span class="mi">302</span> <span class="ow">is</span> <span class="n">a</span> <span class="n">goal</span> <span class="p">(</span><span class="mf">10.5</span><span class="o">%</span><span class="p">)</span><span class="o">.</span>
<span class="n">We</span> <span class="n">have</span> <span class="mi">536</span> <span class="n">shots</span> <span class="n">by</span> <span class="n">free</span> <span class="n">kick</span><span class="p">,</span> <span class="n">of</span> <span class="n">which</span> <span class="mi">28</span> <span class="ow">is</span> <span class="n">a</span> <span class="n">goal</span> <span class="p">(</span><span class="mf">5.2</span><span class="o">%</span><span class="p">)</span><span class="o">.</span>
<span class="n">We</span> <span class="n">have</span> <span class="mi">15724</span> <span class="n">shots</span> <span class="kn">from</span> <span class="nn">all</span> <span class="n">situations</span> <span class="n">combined</span><span class="p">,</span> <span class="n">of</span> <span class="n">which</span> <span class="mi">1611</span> <span class="ow">is</span> <span class="n">a</span> <span class="n">goal</span> <span class="p">(</span><span class="mf">10.2</span><span class="o">%</span><span class="p">)</span><span class="o">.</span>
</pre></div>
</div>
<p>The percentage goals for the in play subsets seems to be relatively
stable. For the free kicks here is a lower percentage of goals scored.
Also note that the total shots and goals has decreased slightly since we
excluded the penalties. However, this is still very describtive, lets
look at the relation between the features and the goals scored.</p>
</section>
<section id="data-exploration">
<h2>Data exploration<a class="headerlink" href="#data-exploration" title="Link to this heading"></a></h2>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_shot_angle</span><span class="p">(</span><span class="n">x</span><span class="p">:</span><span class="nb">float</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span><span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Given a x, y coordinate, calculates the angle in degrees between</span>
<span class="sd">    the vector from the ball to the left post and the vector form the ball</span>
<span class="sd">    to the right post.&quot;&quot;&quot;</span>

    <span class="n">ball_xy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">])</span>
    <span class="n">left_post_xy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">53</span><span class="p">,</span> <span class="mf">3.66</span><span class="p">])</span>
    <span class="n">right_post_xy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">53</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.66</span><span class="p">])</span>

    <span class="n">ball_left_post_vector</span> <span class="o">=</span> <span class="n">left_post_xy</span> <span class="o">-</span> <span class="n">ball_xy</span>
    <span class="n">ball_right_post_vector</span> <span class="o">=</span> <span class="n">right_post_xy</span> <span class="o">-</span> <span class="n">ball_xy</span>

    <span class="n">angle</span> <span class="o">=</span> <span class="n">get_smallest_angle</span><span class="p">(</span>
            <span class="n">ball_left_post_vector</span><span class="p">,</span> <span class="n">ball_right_post_vector</span><span class="p">,</span> <span class="n">angle_format</span><span class="o">=</span><span class="s2">&quot;degree&quot;</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">angle</span>

<span class="n">left_post_xy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">53</span><span class="p">,</span> <span class="mf">3.66</span><span class="p">])</span>
<span class="n">right_post_xy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">53</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.66</span><span class="p">])</span>

<span class="n">x_locs</span> <span class="o">=</span> <span class="p">[</span><span class="mi">53</span><span class="o">-</span><span class="mf">16.5</span><span class="p">,</span> <span class="mi">52</span><span class="o">-</span><span class="mi">24</span><span class="p">,</span> <span class="mi">53</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">53</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span>
<span class="n">y_locs</span> <span class="o">=</span> <span class="p">[</span><span class="mi">12</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="o">-</span><span class="mi">30</span><span class="p">]</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plot_soccer_pitch</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x_locs</span><span class="p">,</span> <span class="n">y_locs</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;shot location&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
<span class="n">n</span> <span class="o">=</span> <span class="mi">1</span>
<span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">x_locs</span><span class="p">,</span> <span class="n">y_locs</span><span class="p">):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">left_post_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="n">y</span><span class="p">,</span> <span class="n">left_post_xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=-</span><span class="mf">.05</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">right_post_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="n">y</span><span class="p">,</span> <span class="n">right_post_xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=-</span><span class="mf">.05</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">-</span><span class="mf">0.15</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">shot_angle</span> <span class="o">=</span> <span class="n">get_shot_angle</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">distance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">x</span><span class="o">-</span><span class="mi">53</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">angle_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;shot angle: $</span><span class="si">{</span><span class="n">shot_angle</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">^</span><span class="se">{{\\</span><span class="s2">circ</span><span class="se">}}</span><span class="s2">$&quot;</span>
    <span class="n">distance_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;shot distance: </span><span class="si">{</span><span class="n">distance</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> m&quot;</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">angle_text</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="n">y</span> <span class="o">-</span> <span class="mf">1.3</span><span class="p">,</span> <span class="n">distance_text</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span> <span class="s2">&quot;upper center&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<img alt="_images/output_8_0.png" src="_images/output_8_0.png" />
<p>Before really going into the data exploration, it is good to talk about
what the features actually mean. The distance is the distance of the
ball till the center of the goal in meters. The angle is the angle
between two vectors: (1) the vector between the shot location and the
right post, and (2) the vector between the shot location and the left
post. The shot angle is therefore a function of the distance to the goal
and the angle with the goal. For instance, the shot angle for shot 1 and
2 are almost equal, but shot 1 is closer to the goal, however, it is
also moved out to the side more. Shot 3 and 4 are perfectly aligned
between each other, but shot 4 has an angle of 4 degrees and shot 3 of
13 degrees. This is of course because the distance to the goal is a lot
higher for shot 4 compared to shot 3.</p>
<p>Now that you have a feel for the features we use, lets look at how they
relate with goal scoring probabilities.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">data</span><span class="p">,</span> <span class="n">title</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">all_datasets</span><span class="p">,</span> <span class="n">titles</span><span class="p">):</span>

    <span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax3</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

    <span class="c1"># distances</span>
    <span class="n">bins_distances</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;ball_goal_distance&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;ball_goal_distance&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="mi">20</span><span class="p">)</span>
    <span class="n">hist_goals_dist</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;shot_outcome&quot;</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;ball_goal_distance&quot;</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins_distances</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">hist_total_dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;ball_goal_distance&quot;</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins_distances</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">a_min</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">,</span> <span class="n">a_max</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="n">percentage_goals_distances</span> <span class="o">=</span> <span class="n">hist_goals_dist</span> <span class="o">/</span> <span class="n">hist_total_dist</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;shot_outcome&quot;</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;ball_goal_distance&quot;</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;No goal&quot;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;shot_outcome&quot;</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;ball_goal_distance&quot;</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Goal&quot;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Ball-Goal Distance&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Frequency&#39;</span><span class="p">)</span>

    <span class="n">ax2</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">bins_distances</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">percentage_goals_distances</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Goal Ratio&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper left&quot;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper right&quot;</span><span class="p">)</span>

    <span class="c1"># angles</span>
    <span class="n">bins_angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;shot_angle&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;shot_angle&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="mi">20</span><span class="p">)</span>
    <span class="n">hist_goals_angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;shot_outcome&quot;</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;shot_angle&quot;</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins_angles</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">hist_total_angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;shot_angle&quot;</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins_angles</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">a_min</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">,</span> <span class="n">a_max</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">percentage_goals_angles</span> <span class="o">=</span> <span class="n">hist_goals_angles</span> <span class="o">/</span> <span class="n">hist_total_angles</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;shot_outcome&quot;</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;shot_angle&quot;</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;No goal&quot;</span><span class="p">)</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;shot_outcome&quot;</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;shot_angle&quot;</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Goal&quot;</span><span class="p">)</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Shot Angle&#39;</span><span class="p">)</span>

    <span class="n">ax4</span> <span class="o">=</span> <span class="n">ax3</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
    <span class="n">ax4</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">bins_angles</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">percentage_goals_angles</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Goal Ratio&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">ax4</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Goal Ratio&quot;</span><span class="p">)</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper left&quot;</span><span class="p">)</span>
    <span class="n">ax4</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper right&quot;</span><span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<img alt="_images/output_10_0.png" src="_images/output_10_0.png" />
<img alt="_images/output_10_1.png" src="_images/output_10_1.png" />
<img alt="_images/output_10_2.png" src="_images/output_10_2.png" />
<img alt="_images/output_10_3.png" src="_images/output_10_3.png" />
<p>This is very interesting! We can clearly see a few things. Firstly, for
the shot distance you can see an exponentional decreasing ratio of shots
being scored as the distance to the shot to the goal increases.
Secondly, there seems to be a linear increase in the ratio of shots
being scored with the increase of the shot angle. It seems that these
variables do indeed hold information about whether a shot is going to be
a goal or not. You can also clearly see that the goal ratio values
become more and more random as we have less samples, for instance when
shots are taken from more than 30 meters or in general in the free kick
data.</p>
</section>
<section id="building-the-xg-models">
<h2>Building the xG models<a class="headerlink" href="#building-the-xg-models" title="Link to this heading"></a></h2>
<p>We will build the expected goal models for every type of shot. For this
we will simply use a logistic regression since it is easiest to
interpretet.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">models</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">scalers</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>

<span class="k">for</span> <span class="n">data</span><span class="p">,</span> <span class="n">title</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">all_datasets</span><span class="p">,</span> <span class="n">titles</span><span class="p">):</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;shot_outcome&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;category&quot;</span><span class="p">)</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">data</span><span class="p">[[</span><span class="s2">&quot;ball_goal_distance&quot;</span><span class="p">,</span> <span class="s2">&quot;shot_angle&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">)</span>

    <span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
    <span class="n">X_preprocessed</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="n">scalers</span><span class="p">[</span><span class="n">title</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaler</span>

    <span class="n">logistic_reg</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">solver</span><span class="o">=</span><span class="s2">&quot;liblinear&quot;</span><span class="p">)</span>
    <span class="n">logistic_reg</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_preprocessed</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
    <span class="n">models</span><span class="p">[</span><span class="n">title</span><span class="p">]</span> <span class="o">=</span> <span class="n">logistic_reg</span>

    <span class="n">X_test_preprocessed</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="n">y_pred_proba</span> <span class="o">=</span> <span class="n">logistic_reg</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test_preprocessed</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>

    <span class="n">brier_loss</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">brier_score_loss</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_proba</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">beta_values</span> <span class="o">=</span> <span class="n">logistic_reg</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;For the </span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">: Brier Score Loss: </span><span class="si">{</span><span class="n">brier_loss</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="s2">&quot;shot distance&quot;</span><span class="p">,</span> <span class="s2">&quot;shot angle&quot;</span><span class="p">]):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2"> beta: </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">beta_values</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">For</span> <span class="n">the</span> <span class="n">shots</span> <span class="n">by</span> <span class="n">foot</span><span class="p">:</span> <span class="n">Brier</span> <span class="n">Score</span> <span class="n">Loss</span><span class="p">:</span> <span class="mf">0.083</span>
    <span class="n">shot</span> <span class="n">distance</span> <span class="n">beta</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.611</span>
    <span class="n">shot</span> <span class="n">angle</span> <span class="n">beta</span><span class="p">:</span> <span class="mf">0.317</span>
<span class="n">For</span> <span class="n">the</span> <span class="n">shots</span> <span class="n">by</span> <span class="n">header</span><span class="p">:</span> <span class="n">Brier</span> <span class="n">Score</span> <span class="n">Loss</span><span class="p">:</span> <span class="mf">0.09</span>
    <span class="n">shot</span> <span class="n">distance</span> <span class="n">beta</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.579</span>
    <span class="n">shot</span> <span class="n">angle</span> <span class="n">beta</span><span class="p">:</span> <span class="mf">0.215</span>
<span class="n">For</span> <span class="n">the</span> <span class="n">shots</span> <span class="n">by</span> <span class="n">free</span> <span class="n">kick</span><span class="p">:</span> <span class="n">Brier</span> <span class="n">Score</span> <span class="n">Loss</span><span class="p">:</span> <span class="mf">0.057</span>
    <span class="n">shot</span> <span class="n">distance</span> <span class="n">beta</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.816</span>
    <span class="n">shot</span> <span class="n">angle</span> <span class="n">beta</span><span class="p">:</span> <span class="mf">0.083</span>
<span class="n">For</span> <span class="n">the</span> <span class="n">shots</span> <span class="kn">from</span> <span class="nn">all</span> <span class="n">situations</span> <span class="n">combined</span><span class="p">:</span> <span class="n">Brier</span> <span class="n">Score</span> <span class="n">Loss</span><span class="p">:</span> <span class="mf">0.086</span>
    <span class="n">shot</span> <span class="n">distance</span> <span class="n">beta</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.441</span>
    <span class="n">shot</span> <span class="n">angle</span> <span class="n">beta</span><span class="p">:</span> <span class="mf">0.319</span>
</pre></div>
</div>
</section>
<section id="inspecting-the-models">
<h2>Inspecting the models<a class="headerlink" href="#inspecting-the-models" title="Link to this heading"></a></h2>
<p>Looking at the brier score losses, we see that the models have
definately trained pretty good. With more data, more complex models and
more complex features we could do better, but for the simplest possible
model, I am happy with these initial results. The Brier score indicates
that the free kick model was best fitted, even though we now that model
had the least data. This is probably because the ratio of free kicks
being scored was very low (5%), therefore the model can perform really
well by guessing every shot is no goal, let’s hope, that is not what the
model learned.</p>
<p>Taking it a step further, we can look at the beta values. Personally, I
would expect negative beta values for the distance feature (greater
distance makes it harder to score) and postive values of the shot angle
feature (greater shot angle means you are either closer or more in front
of the goal, making it easier to score).</p>
<p>Looking at the results we see that indeed the distance beta value is
negative for all models, with values between -0.82 and -0.44. This shows
that a greater distance is decreasing the chance of scoring more for
free kicks than for regular play shots by foot and headers. The beta
angle values are all positive, also as expected. Looking at the beta
values we can see that in all models the distance variable was the most
important in predicting whether a shot will be a goal.</p>
<p>Lets look at some visualizations to confirm that the model predicts
intuitive xG values.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
<span class="n">y_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">34</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
<span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x_range</span><span class="p">,</span> <span class="n">y_range</span><span class="p">)</span>
<span class="n">goal_x</span><span class="p">,</span> <span class="n">goal_y</span> <span class="o">=</span> <span class="mi">53</span><span class="p">,</span> <span class="mi">0</span>
<span class="n">distance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">goal_x</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">goal_y</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span><span class="n">get_shot_angle</span><span class="p">)(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

<span class="n">colors</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">alpha</span><span class="p">)</span> <span class="k">for</span> <span class="n">alpha</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.001</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mi">256</span><span class="p">)]</span>
<span class="n">custom_cmap</span> <span class="o">=</span> <span class="n">LinearSegmentedColormap</span><span class="o">.</span><span class="n">from_list</span><span class="p">(</span><span class="s1">&#39;custom_red&#39;</span><span class="p">,</span> <span class="n">colors</span><span class="p">)</span>

<span class="k">for</span> <span class="n">title</span> <span class="ow">in</span> <span class="n">titles</span><span class="p">:</span>
    <span class="n">X_heatmap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">distance</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">angle</span><span class="o">.</span><span class="n">ravel</span><span class="p">()))</span>
    <span class="n">preprocessing_pipeline</span> <span class="o">=</span> <span class="n">preproc_pipelines</span><span class="p">[</span><span class="n">title</span><span class="p">]</span>
    <span class="n">X_heatmap_preprocessed</span> <span class="o">=</span> <span class="n">preprocessing_pipeline</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_heatmap</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="p">[</span><span class="n">title</span><span class="p">]</span>
    <span class="n">xG_values</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_heatmap_preprocessed</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">xG_matrix</span> <span class="o">=</span> <span class="n">xG_values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">title</span> <span class="o">==</span> <span class="s2">&quot;shots by free kick&quot;</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">20.5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="mi">37</span><span class="p">)</span>
        <span class="n">xG_matrix</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plot_soccer_pitch</span><span class="p">(</span><span class="n">pitch_color</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">)</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">xG_matrix</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="o">-</span><span class="mi">34</span><span class="p">,</span> <span class="mi">34</span><span class="p">],</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">custom_cmap</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">cax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
    <span class="n">cax</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;Expected Goals (xG)&#39;</span><span class="p">)</span>
    <span class="n">contour</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xG_matrix</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="p">[</span><span class="mf">0.07</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">],</span> <span class="n">linestyles</span><span class="o">=</span><span class="s1">&#39;solid&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">clabel</span><span class="p">(</span><span class="n">contour</span><span class="p">,</span> <span class="n">inline</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
</pre></div>
</div>
<img alt="_images/output_14_0.png" src="_images/output_14_0.png" />
<img alt="_images/output_14_1.png" src="_images/output_14_1.png" />
<img alt="_images/output_14_2.png" src="_images/output_14_2.png" />
<img alt="_images/output_14_3.png" src="_images/output_14_3.png" />
<p>The xG model for the shots by foot in regular play and of all shots are
pretty similar. This is because most shots in our dataset were shots by
foot in regular play. You can also clearly see that the distance
component is more limiting for the headers than for the shots. On top of
that, it is interesting to see that free kicks from just outside the box
have a twice as high probability of being a goal than regular shots do,
so shooting from that distance out of a free kick can be justified. Over
all, we can see that creating xG models for different types of shots
seems to be better than one single xG model for all shots. Let’s save
the models so we can use it in DataBallPy!</p>
</section>
<section id="saving-the-models">
<h2>Saving the models<a class="headerlink" href="#saving-the-models" title="Link to this heading"></a></h2>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">save_dir</span> <span class="o">=</span> <span class="s2">&quot;../databallpy/models&quot;</span>

<span class="k">for</span> <span class="n">title</span><span class="p">,</span> <span class="n">save_name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">titles</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;xG_by_foot_pipeline&quot;</span><span class="p">,</span> <span class="s2">&quot;xG_by_head_pipeline&quot;</span><span class="p">,</span> <span class="s2">&quot;xG_free_kick_pipeline&quot;</span><span class="p">]):</span>
    <span class="n">prerpoc_pipeline</span> <span class="o">=</span> <span class="n">preproc_pipelines</span><span class="p">[</span><span class="n">title</span><span class="p">]</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="p">[</span><span class="n">title</span><span class="p">]</span>
    <span class="n">pipeline</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span>
        <span class="p">(</span><span class="s2">&quot;Preprocessor&quot;</span><span class="p">,</span> <span class="n">prerpoc_pipeline</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;log_reg&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">),</span>
        <span class="p">])</span>

    <span class="n">joblib</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">save_dir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">save_name</span><span class="si">}</span><span class="s2">.pkl&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># shortly check if saving the models went right</span>
<span class="n">distance</span> <span class="o">=</span> <span class="mi">16</span> <span class="c1"># meters</span>
<span class="n">angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="mf">3.66</span> <span class="o">/</span> <span class="mi">16</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="c1"># directly in front of the goal</span>

<span class="k">for</span> <span class="n">save_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;xG_by_foot_pipeline&quot;</span><span class="p">,</span> <span class="s2">&quot;xG_by_head_pipeline&quot;</span><span class="p">,</span> <span class="s2">&quot;xG_free_kick_pipeline&quot;</span><span class="p">]:</span>
    <span class="n">xg</span> <span class="o">=</span> <span class="n">joblib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">save_dir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">save_name</span><span class="si">}</span><span class="s2">.pkl&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">save_name</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">xg</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">distance</span><span class="p">,</span> <span class="n">angle</span><span class="p">]]))[:,</span> <span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="mi">3</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">xG_by_foot_pipeline</span>
     <span class="mf">0.11</span>
<span class="n">xG_by_head_pipeline</span>
     <span class="mf">0.03</span>
<span class="n">xG_free_kick_pipeline</span>
     <span class="mf">0.204</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="example.html" class="btn btn-neutral float-left" title="Example usage" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="changelog.html" class="btn btn-neutral float-right" title="Changelog" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Alexander Oonk &amp; Daan Grob.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>